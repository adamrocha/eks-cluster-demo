#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
export PROJECT_ROOT

OS_TYPE="$(uname -s)"
APT_UPDATED=0

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

apt_update_once() {
    if [[ $APT_UPDATED -eq 0 ]]; then
        sudo apt-get update -y >/dev/null
        APT_UPDATED=1
    fi
}

install_package() {
    local pkg="$1"
    case "$OS_TYPE" in
        Darwin)
            command -v brew >/dev/null 2>&1 || { echo "Install Homebrew first"; exit 1; }
            brew install "$pkg"
            ;;
        Linux)
            if command -v apt-get >/dev/null 2>&1; then
                apt_update_once
                sudo apt-get install -y "$pkg" >/dev/null
            elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y "$pkg" >/dev/null
            else
                echo "Unsupported Linux package manager. Install $pkg manually."
                exit 1
            fi
            ;;
        *)
            echo "Unsupported OS: $OS_TYPE"
            exit 1
            ;;
    esac
}

install_hashicorp_tool() {
    local tool="$1"
    if ! command -v "$tool" >/dev/null 2>&1; then
        echo "Installing $tool..."
        if [[ "$OS_TYPE" == "Darwin" ]]; then
            brew tap hashicorp/tap >/dev/null 2>&1 || true
            brew install "hashicorp/tap/$tool"
        else
            install_package "$tool"
        fi
    else
        echo "$tool already installed."
    fi
}

ensure_command() {
    local cmd="$1"
    local pkg="${2:-$1}"
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo "Installing $cmd..."
        install_package "$pkg"
    else
        echo "$cmd already installed."
    fi
}

# ------------------------------------------------------------
# AWS CLI + Config
# ------------------------------------------------------------

ensure_command aws awscli

AWS_CONFIG="$HOME/.aws/config"
if [[ -f "$AWS_CONFIG" ]]; then
    echo "AWS config already exists at $AWS_CONFIG"
else
    mkdir -p "$HOME/.aws"
    cat > "$AWS_CONFIG" <<'EOF'
[default]
region = us-east-1
output = json

[profile prom_infradmin]
region = us-east-1
output = json
#credential_process = aws-pass-creds
EOF
    echo "AWS config created at $AWS_CONFIG"
fi

# ------------------------------------------------------------
# Session Manager Plugin
# ------------------------------------------------------------

if ! command -v session-manager-plugin >/dev/null 2>&1; then
    echo "Installing session-manager-plugin..."
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        brew install --cask session-manager-plugin
    elif [[ "$OS_TYPE" == "Linux" ]]; then
        curl -sSL "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" \
            -o "/tmp/session-manager-plugin.deb"
        sudo dpkg -i /tmp/session-manager-plugin.deb
        rm /tmp/session-manager-plugin.deb
    fi
else
    echo "session-manager-plugin already installed."
fi

# ------------------------------------------------------------
# AWS Credentials (from pass)
# ------------------------------------------------------------

export AWS_ACCESS_KEY_ID="$(pass aws/dev/aws_access_key_id)"
export AWS_SECRET_ACCESS_KEY="$(pass aws/dev/aws_secret_access_key)"

if aws sts get-caller-identity &>/dev/null; then
    echo "Authenticated with AWS."
else
    echo "Not authenticated with AWS. Configure your AWS CLI."
    exit 1
fi

# ------------------------------------------------------------
# Tool Installs
# ------------------------------------------------------------

install_hashicorp_tool terraform
install_hashicorp_tool vault
ensure_command make
ensure_command kubectl
ensure_command jq
ensure_command docker docker.io docker-buildx
ensure_command helm
ensure_command pass

# ------------------------------------------------------------
# Vault Environment
# ------------------------------------------------------------

export VAULT_ADDR="$(pass vault/dev/address)"
export VAULT_TOKEN="$(pass vault/dev/token)"
