#!/usr/bin/env bash
set -euo pipefail

export PROJECT_ROOT="${PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"

# ------------------------------------------------------------
# AWS Credentials
# ------------------------------------------------------------

if ! command -v pass >/dev/null 2>&1; then
    echo "pass command not found. Please run 'make install-tools' for tooling setup."
    exit 1
else
    export AWS_ACCOUNT_ID="${AWS_ACCOUNT_ID:-$(pass aws/dev/account_id)}"
    export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-$(pass aws/dev/aws_access_key_id)}"
    export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-$(pass aws/dev/aws_secret_access_key)}"
fi

if ! aws sts get-caller-identity >/dev/null 2>&1; then
  echo "Not authenticated with AWS"
  exit 1
fi

# ------------------------------------------------------------
# Vault Environment
# ------------------------------------------------------------

export VAULT_ADDR="${VAULT_ADDR:-$(pass vault/dev/address)}"
export VAULT_TOKEN="${VAULT_TOKEN:-$(pass vault/dev/token)}"