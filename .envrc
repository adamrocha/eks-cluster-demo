#!/usr/bin/env bash

set -euo pipefail

# Project root directory (defaults to git root or current directory)
export PROJECT_ROOT="${PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"

# ------------------------------------------------------------
# AWS Credentials
# ------------------------------------------------------------

if ! aws sts get-caller-identity >/dev/null 2>&1; then
	# If AWS CLI is not configured, attempt to load credentials from pass
	export AWS_ACCOUNT_ID="${AWS_ACCOUNT_ID:-$(pass aws/dev/aws_account_id)}"
	export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-$(pass aws/dev/aws_access_key_id)}"
	export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-$(pass aws/dev/aws_secret_access_key)}"
else
	exit 1
fi

# ------------------------------------------------------------
# Vault Environment
# ------------------------------------------------------------

if [[ -f "${PROJECT_ROOT}/terraform/vault.tf" ]]; then
	# If Vault is not configured, attempt to load credentials from pass
	export VAULT_ADDR="${VAULT_ADDR:-$(pass vault/dev/address)}"
	export VAULT_TOKEN="${VAULT_TOKEN:-$(pass vault/dev/token)}"
fi

# ------------------------------------------------------------
# Poetry Virtual Environment Setup
# ------------------------------------------------------------

if [[ ! -d "${PROJECT_ROOT}/.venv" ]]; then
	# If the virtual environment does not exist, create it using Poetry
	VENV="$(poetry env activate)"
	eval "${VENV}"
	poetry install
fi

if [[ -d "${PROJECT_ROOT}/.venv" ]]; then
	source "${PROJECT_ROOT}/.venv/bin/activate"
fi
