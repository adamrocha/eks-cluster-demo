#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
export PROJECT_ROOT

OS_TYPE="$(uname -s)"
APT_UPDATED=0

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

apt_update_once() {
    if [[ $APT_UPDATED -eq 0 ]]; then
        sudo apt-get update -y >/dev/null
        APT_UPDATED=1
    fi
}

install_package() {
    local pkg="$1"
    case "$OS_TYPE" in
        Darwin)
            command -v brew >/dev/null 2>&1 || { echo "Install Homebrew first"; exit 1; }
            if ! brew list "$pkg" >/dev/null 2>&1; then
                echo "Installing $pkg via Homebrew..."
            else
                echo "$pkg already installed."
                return
            fi
            brew install "$pkg"
            ;;
        Linux)
            if command -v apt-get >/dev/null 2>&1; then
                apt_update_once
                sudo NEEDRESTART_MODE=a apt-get install -y "$pkg" >/dev/null
            elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y "$pkg" >/dev/null
            else
                echo "Unsupported Linux package manager. Install $pkg manually."
                exit 1
            fi
            ;;
        *)
            echo "Unsupported OS: $OS_TYPE"
            exit 1
            ;;
    esac
}

install_hashicorp_tool() {
    local tool="$1"
    if ! command -v "$tool" >/dev/null 2>&1; then
        echo "Installing $tool..."
        if [[ "$OS_TYPE" == "Darwin" ]]; then
            brew tap hashicorp/tap >/dev/null 2>&1 || true
            brew install "hashicorp/tap/$tool"
        elif [[ "$OS_TYPE" == "Linux" ]]; then
            ensure_hashicorp_repo
        else
            install_package "$tool"
        fi
    else
        echo "$tool already installed."
    fi
}

ensure_command() {
    local cmd="$1"
    local pkg="${2:-$1}"
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo "Installing $cmd..."
        install_package "$pkg"
    else
        echo "$cmd already installed."
    fi
}

# ------------------------------------------------------------
# AWS CLI + Config
# ------------------------------------------------------------

ensure_command aws awscli

AWS_CONFIG="$HOME/.aws/config"
if [[ -f "$AWS_CONFIG" ]]; then
    echo "AWS config already exists at $AWS_CONFIG"
else
    mkdir -p "$HOME/.aws"
    cat > "$AWS_CONFIG" <<'EOF'
[default]
region = us-east-1
output = json

[profile prom_infradmin]
region = us-east-1
output = json
#credential_process = aws-pass-creds
EOF
    echo "AWS config created at $AWS_CONFIG"
fi

# ------------------------------------------------------------
# Session Manager Plugin
# ------------------------------------------------------------

# Check if session-manager-plugin is installed
if ! command -v session-manager-plugin --version &> /dev/null; then
    echo "session-manager-plugin is not installed. Installing it now..."
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        brew install --cask session-manager-plugin
    elif [[ "$OS_TYPE" == "Linux" ]]; then
        ARCH="$(uname -m)"
        case "$ARCH" in
            x86_64|amd64)
                URL="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb"
                ;;
            aarch64|arm64)
                URL="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_arm64/session-manager-plugin.deb"
                ;;
            *)
                echo "Unsupported architecture: $ARCH"
                exit 1
                ;;
        esac
        curl -sSL "$URL" -o "/tmp/session-manager-plugin.deb"
        sudo dpkg -i /tmp/session-manager-plugin.deb || sudo apt-get install -f -y
        rm /tmp/session-manager-plugin.deb
    fi
else
    echo "session-manager-plugin is already installed."
fi

# ------------------------------------------------------------
# Special installers
# ------------------------------------------------------------

ensure_helm() {
    if ! command -v helm >/dev/null 2>&1; then
        echo "Installing Helm..."
        if [[ "$OS_TYPE" == "Linux" ]]; then
            curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
        else
            install_package helm
        fi
    else
        echo "Helm is already installed."
    fi
}

ensure_hashicorp_repo() {
    if [[ "$OS_TYPE" == "Linux" ]] && ! grep -q "hashicorp" /etc/apt/sources.list.d/hashicorp.list 2>/dev/null; then
        echo "Adding HashiCorp repository..."
        wget -O- https://apt.releases.hashicorp.com/gpg | \
            gpg --dearmor | \
            sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/hashicorp.list
    fi
}

ensure_kubectl() {
    if ! command -v kubectl >/dev/null 2>&1; then
        echo "Installing kubectl..."
        if [[ "$OS_TYPE" == "Linux" ]]; then
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key \
            | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            sudo chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg

            echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /' \
            | sudo tee /etc/apt/sources.list.d/kubernetes.list
            sudo chmod 644 /etc/apt/sources.list.d/kubernetes.list
        else
            install_package kubectl
        fi
    else
        echo "kubectl is already installed."
    fi
}

# ------------------------------------------------------------
# Tool Installs
# ------------------------------------------------------------

ensure_command make
ensure_command kubectl
ensure_command jq
ensure_command docker docker.io docker-buildx
ensure_command pass
ensure_helm
ensure_hashicorp_repo
install_hashicorp_tool terraform
install_hashicorp_tool vault

# ------------------------------------------------------------
# AWS Credentials (from pass)
# ------------------------------------------------------------

export AWS_ACCESS_KEY_ID="$(pass aws/dev/aws_access_key_id)"
export AWS_SECRET_ACCESS_KEY="$(pass aws/dev/aws_secret_access_key)"

if aws sts get-caller-identity &>/dev/null; then
    echo "Authenticated with AWS."
else
    echo "Not authenticated with AWS. Configure your AWS CLI."
    exit 1
fi

# ------------------------------------------------------------
# Vault Environment
# ------------------------------------------------------------

export VAULT_ADDR="$(pass vault/dev/address)"
export VAULT_TOKEN="$(pass vault/dev/token)"
